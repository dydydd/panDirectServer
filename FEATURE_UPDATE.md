# 🎉 新功能：设备管理 & 客户端拦截

## ✨ 新增功能

### 1. 💻 设备管理
查看和管理所有连接到服务的客户端设备。

#### 功能特性
- 📊 **设备统计**
  - 总设备数
  - 活跃设备数
  - 今日新增设备
  - 最后活动时间

- 📋 **设备列表**
  - 设备名称
  - 设备ID（唯一标识）
  - 客户端类型（Emby Web、App等）
  - IP地址
  - 最后访问时间
  - 快速拉黑操作

- 🔄 **实时刷新**
  - 一键刷新设备列表
  - 查看最新连接状态

#### 使用场景
- 监控哪些设备在使用服务
- 发现异常设备并及时拉黑
- 了解服务使用情况
- 设备访问历史记录

### 2. 🛡️ 客户端拦截
精细化控制客户端访问权限，提升服务安全性。

#### 拦截模式
**白名单模式**（推荐）
- 仅允许列表中的设备访问
- 适合固定设备场景
- 安全性最高

**黑名单模式**
- 拒绝列表中的设备访问
- 适合开放使用场景
- 灵活性更高

#### 配置项
1. **客户端白名单**
   - 添加允许访问的设备ID
   - 每行一个设备ID
   - 支持UUID格式

2. **客户端黑名单**
   - 添加禁止访问的设备ID
   - 立即生效
   - 可随时移除

3. **IP白名单**
   - 允许特定IP地址访问
   - 支持IP段（CIDR格式）
   - 适合企业内网场景

#### 测试功能
- 输入设备ID测试是否允许访问
- 实时查看拦截结果
- 显示拦截原因

## 📱 界面更新

### 新增导航栏分组
```
主菜单
├─ 📊 仪表盘
├─ 🎬 Emby设置
├─ ☁️ 123网盘
└─ ⚙️ 服务设置

高级功能（新增）
├─ 💻 设备管理      ← 新增
└─ 🛡️ 客户端拦截    ← 新增
```

### 设备管理页面
- 📊 顶部统计卡片（4项指标）
- 📋 设备表格（6列数据）
- 🎨 清晰的表格样式
- ⚡ 悬停高亮效果
- 🔴 快速拉黑按钮

### 客户端拦截页面
- ⚙️ 拦截开关（启用/禁用）
- 📋 拦截模式选择
- 📝 三个文本区域（白名单、黑名单、IP白名单）
- 🧪 测试规则功能
- 💾 保存配置按钮

## 🎨 样式优化

### 设备表格样式
- 清晰的表头（灰色背景）
- 交替行背景色
- 悬停高亮效果
- 等宽字体显示设备ID
- 圆角设计

### 按钮样式
- 小号按钮（用于表格操作）
- 危险按钮（红色，用于拉黑）
- 统一的交互反馈

### 卡片布局
- 分组显示配置项
- 清晰的标题图标
- 灰色提示文字
- 统一的间距

## 🔌 API接口

### 设备管理接口

#### 获取设备列表
```
GET /api/devices

响应:
{
  "code": 200,
  "data": {
    "devices": [
      {
        "name": "设备名称",
        "device_id": "uuid",
        "client": "Emby Web",
        "ip": "192.168.1.100",
        "last_seen": "2024-01-01T12:00:00"
      }
    ],
    "stats": {
      "total": 10,
      "active": 5,
      "new_today": 2,
      "last_activity": "刚刚"
    }
  }
}
```

#### 拉黑设备
```
POST /api/devices/block

请求体:
{
  "device_id": "uuid"
}

响应:
{
  "code": 200,
  "message": "设备已拉黑"
}
```

### 拦截配置接口

#### 获取拦截配置
```
GET /api/intercept/config

响应:
{
  "code": 200,
  "data": {
    "enable": true,
    "mode": "whitelist",
    "whitelist_devices": ["device-id-1", "device-id-2"],
    "blacklist_devices": ["blocked-id"],
    "whitelist_ips": ["192.168.1.0/24"]
  }
}
```

#### 保存拦截配置
```
POST /api/intercept/config

请求体:
{
  "enable": true,
  "mode": "whitelist",
  "whitelist_devices": ["device-id-1"],
  "blacklist_devices": [],
  "whitelist_ips": ["192.168.1.0/24"]
}

响应:
{
  "code": 200,
  "message": "配置保存成功"
}
```

#### 测试拦截规则
```
POST /api/intercept/test

请求体:
{
  "device_id": "test-device-id"
}

响应:
{
  "code": 200,
  "data": {
    "allowed": true,
    "reason": "设备在白名单中"
  }
}
```

## 📖 使用指南

### 设备管理使用流程

1. **查看设备**
   - 点击左侧"设备管理"
   - 点击"刷新"按钮加载设备列表
   - 查看所有连接过的设备

2. **拉黑设备**
   - 在设备列表中找到目标设备
   - 点击"拉黑"按钮
   - 确认操作
   - 设备立即被禁止访问

3. **监控活跃度**
   - 查看顶部统计卡片
   - 了解总设备数和活跃设备
   - 查看最后活动时间

### 客户端拦截使用流程

1. **启用拦截**
   - 点击左侧"客户端拦截"
   - 打开"启用客户端拦截"开关
   - 选择拦截模式

2. **配置白名单（推荐）**
   - 选择"白名单模式"
   - 在白名单文本框中添加允许的设备ID
   - 每行一个ID
   - 点击"保存拦截配置"

3. **配置黑名单**
   - 选择"黑名单模式"
   - 在黑名单文本框中添加禁止的设备ID
   - 点击"保存拦截配置"

4. **配置IP白名单**
   - 在IP白名单文本框中添加允许的IP
   - 支持单个IP：`192.168.1.100`
   - 支持IP段：`192.168.1.0/24`
   - 点击"保存拦截配置"

5. **测试规则**
   - 点击"测试规则"按钮
   - 输入设备ID
   - 查看是否允许访问

## 🔐 安全建议

### 白名单模式（高安全）
适用场景：
- ✅ 家庭使用，设备固定
- ✅ 企业内部，已知设备
- ✅ 对安全要求高

配置步骤：
1. 启用白名单模式
2. 添加所有可信设备ID
3. 添加可信IP段
4. 测试确认无误

### 黑名单模式（灵活）
适用场景：
- ✅ 朋友共享，设备不固定
- ✅ 公开服务，用户众多
- ✅ 需要灵活管理

配置步骤：
1. 启用黑名单模式
2. 从设备管理中拉黑异常设备
3. 手动添加已知恶意设备
4. 定期检查设备列表

### 混合使用
最佳实践：
- 使用白名单模式
- 添加IP白名单（内网段）
- 定期检查设备列表
- 及时拉黑异常设备

## 📊 数据存储

### 设备数据
- 位置：`config/user_history.json`
- 包含：设备ID、名称、IP、访问记录
- 自动更新

### 拦截配置
- 位置：`config/intercept_config.json`（新增）
- 包含：拦截开关、模式、白/黑名单
- 手动保存

## 🎯 应用场景

### 场景1：家庭共享
```
需求：只允许家人的设备访问
方案：
1. 启用白名单模式
2. 添加家人设备ID
3. 添加家庭网络IP段
```

### 场景2：朋友借用
```
需求：临时允许朋友访问
方案：
1. 使用黑名单模式
2. 朋友首次访问后，在设备列表查看
3. 若发现异常，立即拉黑
```

### 场景3：发现异常
```
现象：设备列表出现未知设备
处理：
1. 检查设备ID和IP
2. 确认是否为已知设备
3. 若不是，点击"拉黑"
4. 考虑切换到白名单模式
```

## 🔄 未来计划

- [ ] 设备在线状态实时监控
- [ ] 设备访问频率统计
- [ ] 流量使用统计
- [ ] 自动拉黑异常设备
- [ ] 邮件/通知提醒
- [ ] 设备分组管理
- [ ] 访问日志查看

---

**享受更安全、可控的服务体验！** 🎉

