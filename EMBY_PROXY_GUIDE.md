# Emby 反代和 302 重定向功能使用指南

## 功能概述

PanDirect Server 现在内置了 Emby 反代功能，无需单独部署 nginx 和 emby2Alist，即可实现：

1. **Emby API 代理** - 转发所有 Emby API 请求到真实 Emby 服务器
2. **302 重定向** - 视频播放时自动重定向到网盘直链，减轻服务器负载
3. **路径映射** - 自动将 Emby 媒体库路径映射到网盘路径

## 工作原理

```
Emby 客户端
    ↓
PanDirect Server (/emby)
    ↓
    ├─ API 请求 → Emby 服务器
    └─ 视频请求 → 路径映射 → 网盘直链 (302)
```

### 请求流程

1. **普通 API 请求**（如浏览媒体库、获取信息）
   - 客户端 → PanDirect Server → Emby 服务器
   - 直接代理，透明转发

2. **视频播放请求**（如 `/Videos/{id}/stream`）
   - 客户端 → PanDirect Server
   - 查询 Emby API 获取文件路径
   - 路径映射转换为网盘路径
   - 获取网盘直链
   - 302 重定向到直链
   - 客户端直接从网盘下载

## 配置步骤

### 1. Web 界面配置

访问 `http://your-server:5245`，进入 "Emby 反代" 标签页：

#### 基础配置

- **启用 Emby 反代**：勾选此选项
- **Emby 服务器地址**：填写真实 Emby 服务器地址
  ```
  示例：http://192.168.1.100:8096
  ```
- **Emby API Key**：在 Emby 控制台生成
  - 登录 Emby 管理界面
  - 进入 `设置` > `高级` > `API 密钥`
  - 点击 `新建 API 密钥`
  - 填写应用名称（如：PanDirect）
  - 复制生成的密钥

#### 功能开关

- **启用 API 代理**：默认启用，转发所有 API 请求
- **启用 302 重定向**：默认启用，视频播放使用直链

#### 路径映射配置

这是实现 302 重定向的关键配置：

- **启用路径映射**：勾选此选项
- **Emby 路径前缀**：Emby 媒体库中文件的路径前缀
  ```
  示例：/mnt/media 或 /volume1/media
  ```
- **映射到网盘路径**：对应的网盘挂载路径
  ```
  示例：/115 或 /123
  ```

### 2. 路径映射示例

#### 示例 1：Linux Docker 环境

**Emby 配置：**
- 媒体库路径：`/mnt/media/movies`、`/mnt/media/tv`

**网盘结构：**
```
/115/
  ├── movies/
  │   └── 电影A.mp4
  └── tv/
      └── 剧集B/
          └── S01E01.mkv
```

**路径映射配置：**
- Emby 路径前缀：`/mnt/media`
- 网盘路径：`/115`

**映射结果：**
- `/mnt/media/movies/电影A.mp4` → `/115/movies/电影A.mp4`
- `/mnt/media/tv/剧集B/S01E01.mkv` → `/115/tv/剧集B/S01E01.mkv`

#### 示例 2：群晖 NAS 环境

**Emby 配置：**
- 媒体库路径：`/volume1/media/movies`

**网盘结构：**
```
/123/
  └── movies/
      └── 电影A.mp4
```

**路径映射配置：**
- Emby 路径前缀：`/volume1/media`
- 网盘路径：`/123`

**映射结果：**
- `/volume1/media/movies/电影A.mp4` → `/123/movies/电影A.mp4`

### 3. 客户端配置

在 Emby 客户端中修改服务器地址：

#### 原地址：
```
http://192.168.1.100:8096
```

#### 新地址（独立端口模式）：
```
http://your-pandirect-server:8096
```

**注意事项：**
- **Emby 反代运行在独立端口（默认 8096），客户端直接访问此端口**
- 管理界面仍然在主端口 5245：`http://your-pandirect-server:5245`
- 保持用户名和密码不变
- 首次连接需要重新登录
- 所有功能保持正常使用

## 验证配置

### 1. 检查连接

在客户端登录后，检查：
- ✅ 媒体库正常显示
- ✅ 海报和元数据正常加载
- ✅ 视频信息正常显示

### 2. 测试播放

播放视频时，查看 PanDirect Server 日志：

```bash
# Docker 环境
docker-compose logs -f

# 手动运行
# 查看终端输出
```

**正常日志示例：**
```
INFO - 代理请求: GET /Items/12345
INFO - 处理视频项: 12345
INFO - Emby 文件路径: /mnt/media/movies/test.mp4
INFO - 路径映射: /mnt/media/movies/test.mp4 => /115/movies/test.mp4
INFO - 成功获取直链: /115/movies/test.mp4 => https://...
INFO - 302 重定向到: https://...
```

### 3. 网络抓包验证

使用浏览器开发者工具（F12）查看网络请求：

1. 打开 `Network` 标签
2. 播放视频
3. 查找视频请求
4. 确认返回 `302 Found` 状态码
5. 确认 `Location` 头指向网盘直链

## 故障排查

### 问题 1：视频无法播放

**可能原因：**
- 路径映射配置错误
- Emby API Key 无效
- 网盘客户端未连接

**排查步骤：**
1. 检查 PanDirect Server 日志，查看错误信息
2. 验证路径映射是否正确
3. 在 "服务状态" 中检查网盘连接状态
4. 测试手动访问网盘文件

### 问题 2：部分视频可以播放，部分不行

**可能原因：**
- 文件在网盘中不存在
- 路径映射规则不匹配

**解决方案：**
1. 确认 Emby 文件路径和网盘文件路径对应关系
2. 检查大小写是否匹配（Linux 区分大小写）
3. 确认文件在网盘中确实存在

### 问题 3：播放慢或卡顿

**可能原因：**
- 网盘直链速度限制
- 客户端网络问题

**说明：**
- 使用 302 重定向后，视频直接从网盘加载
- 播放速度取决于网盘和客户端的网络
- PanDirect Server 不会成为瓶颈

### 问题 4：302 重定向不生效

**排查步骤：**
1. 确认 "启用 302 重定向" 已勾选
2. 确认 "启用路径映射" 已勾选
3. 查看日志，确认进入 302 处理流程
4. 如果回退到普通代理，检查路径映射配置

## 性能优化

### 1. 启用 302 重定向

- ✅ 服务器带宽占用降至接近 0
- ✅ 支持更多并发播放
- ✅ 网盘 CDN 加速（如果支持）

### 2. 禁用不必要的功能

如果只需要某个网盘：
- 禁用未使用的网盘（115/123）
- 减少资源占用

### 3. 合理配置路径映射

- 使用准确的路径前缀
- 避免过于宽泛的匹配
- 定期检查映射规则

## 与 emby2Alist 的对比

| 特性 | PanDirect Server | emby2Alist + nginx |
|------|------------------|-------------------|
| 部署复杂度 | ⭐ 简单（单个服务） | ⭐⭐⭐ 复杂（需要 nginx + njs） |
| 配置方式 | 🎨 Web 界面 | 📝 修改配置文件 |
| 302 重定向 | ✅ 支持 | ✅ 支持 |
| 多网盘支持 | ✅ 115/123 | ✅ 任意 Alist 支持的网盘 |
| 性能 | 🚀 Python | 🚀🚀 nginx |
| 功能丰富度 | ⭐⭐ 基础功能 | ⭐⭐⭐ 高级功能（HLS 转码等） |

## 最佳实践

1. **先配置网盘，再配置 Emby**
   - 确保网盘正常连接
   - 测试文件直链获取

2. **使用相同的目录结构**
   - Emby 和网盘使用相同的目录组织
   - 便于路径映射

3. **定期检查日志**
   - 及时发现配置问题
   - 优化性能

4. **备份配置**
   - 定期备份 `config/config.json`
   - 便于恢复

## 安全建议

1. **修改默认密码**
   - 及时修改管理员密码
   - 使用强密码

2. **保护 API Key**
   - Emby API Key 不要泄露
   - 定期更换

3. **网络隔离**
   - 仅在内网访问
   - 或使用反向代理 + HTTPS

4. **访问控制**
   - 设置防火墙规则
   - 限制访问来源

## 技术支持

遇到问题？

1. 查看项目 [README.md](README.md)
2. 检查 GitHub Issues
3. 提交新的 Issue（附上日志）

---

**祝使用愉快！** 🎉

